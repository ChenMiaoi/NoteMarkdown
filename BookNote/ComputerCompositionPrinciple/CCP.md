# 计算机组成原理

---

## 计算机系统概述

### 冯诺依曼体系结构

> 冯诺依曼提出了“存储程序”的概念，其思想奠定了现代计算机的基本结构

- 采用“存储程序”的工作方式
- 计算机硬件系统由运算器、存储器、控制器、输入输出设备这五大部件组成
- **指令和数据以同等地位存储在存储器中，形式上没有区别，但计算机能够区分**
- **指令和数据均采用二进制代码表示**。**指令由操作码和地址码组成，操作码指出操作的类型，地址码指出操作数的地址**
- **以运算器为中心** -> 现代计算机以存储器为中心

> “存储程序”的基本思想是：**将事先编好的程序和原始数据送入主存后才能执行，一旦程序被启动执行，就无须操作人员的干预，计算机会自动逐条执行指令，直至程序执行结束**

### 各个硬件的工作原理

#### 主存储器

> CPU能够**直接访问**的存储器是主存储器。**主存储器的工作方式是按存储单元的地址进行存取，这种存储方式称为按地址存取方式**

- 主存储器的最基本组成如下所示：
	- 存储体，存储体存放二进制信息
	- 数据存储寄存器(Memory Data Register)，MAR存放访存地址，经过地址译码后找到所选的存储单元
	- 地址存储寄存器(Memory Address Register)，MDR用于暂存要从存储器中读或写的信息
	- 时序逻辑控制器，用于产生存储器操作所需的各种时序信号

![[主存储器.png]]

##### 存储体

> 存储体由许多存储单元组成，每个存储单元包含若干存储元件，每个存储元件存储一位二进制代码0/1. 因此存储单元可以存储一串二进制代码，这串代码称为存储字，称这串代码的位数为存储字长

- 存储体
	- 存储单元：每个存储单元存放一串二进制代码
	- 存储字(word)：存储单元中二进制代码的组合
	- 存储字长：存储单元中二进制代码的位数
	- 存储元：即存储二进制的电子元件，每个存储元可存储1bit
- **每一个地址都对应一个存储单元**

| 地址 | 存储体 |
| :---: | :---: |
| 0 | 存储单元 |
| 1 | 存储单元 |
| 2 | ... |
| 3 | ... |
| 4 | ... |
| ... | ... |

##### MAR

> MAR用于寻址，**其位数对应着存储单元的个数**，如MAR为10位，则有$2^{10} = 1024$个存储单元。**MAR的长度和PC寄存器的长度相同**

##### MDR

> MDR的位数是存储单元的字长，假如MDR位16位，也就是说一个字的长度位16bit，每个存储单元可存放16bit的数据

> [!warning] 注意，**在现代CPU中，MAR和MDR是存在于CPU中的**

#### 运算器

> 运算器是计算机的执行部件，用于算术运算和逻辑运算。

- 运算器的基本组成如下：
	- 算术逻辑单元(ALU)
	- 寄存器，**前三个寄存器是必须的**
		- 累加寄存器(ACC)
		- 乘商寄存器(MQ)
		- 通用寄存器(X)
		- 变址寄存器(IX)
		- 基址寄存器(BR)
		- ....

- 寄存器作用表

| | 加 | 减 | 乘 | 除 |
| :---: | :---: | :---: | :---: | :---: |
| ACC | 被加数、和 | 被减数、差 | 乘积高位 | 被除数、余数 |
| MQ | | | 乘数、乘积低位 | 商 |
| X | 加数 | 减数 | 被乘数 | 除数 |

![[运算器.png]]

#### 控制器

> 控制器是计算机的指挥中心，使得各部件自动协调地进行工作。控制器由程序计数器(PC)、指令寄存器(IR)和控制单元(CU)组成

- 控制器的基本组成如下所示：
	- PC寄存器，用于**存放当前欲执行指令的地址(也就是下一条指令)**，当执行完毕后自动移动到下一条指令地址的开头。它与主存MAR之间由一条直接通路
	- IR寄存器，用来**存放当前的指令**，其内容来自主存的MDR。指令中的操作码OP(IR)送至CU，用以分析指令并发出各种微操作命令序列，而地址码Ad(IR)送往MAR，用以取操作数
	- CU控制单元，分析指令，给出控制信号

### 计算机的工作过程

![[计算机简单结构.png]]

#### 探究简单C语言代码执行逻辑

``` c
int main() {
	int a = 2, b = 3, c = 1, y = 0;
	y = a * b + c;
	return 0;
}
```

- 编译后装入主存后的结构示意图

| 主存地址 | 操作码 | 地址码 | 注释 |
| :---: | :---: | :---: | :---: |
| 0 | 000001 | 0000000101 | 取数a至ACC | 
| 1 | 000100 | 0000000110 | 乘b得ab，存于ACC中 | 
| 2 | 000011 | 0000000111 | 加c得$ab + c$，存于ACC中 | 
| 3 | 000010 | 0000001000 | 将$ab + c$存于主存单元 | 
| 4 | 000110 | 0000000000 | 停机 | 
| 5 | 000000 | 0000000101 | 原始数据$a=2$ | 
| 6 | 000000 | 0000000101 | 原始数据$b=3$ | 
| 7 | 000000 | 0000000101 | 原始数据$c=1$ | 
| 8 | 000000 | 0000000101 | 原始数据$y=0$ | 

##### 控制器的简单执行逻辑

1. $(PC) = 0x0$，PC寄存器指向第一条指令的存储地址
2. $MAR = (PC)$，MAR得到PC指向的主存地址
3. $(PC) = 0x1$，当PC寄存器执行完后，自动的访问下一条指令的地址
4. $M(MAR) = MDR$， MDR得到MAR指向的主存地址中的数据
5. $IR = (MDR)$，IR得到MDR中对应的指令，开始分析操作码OP(IR)和地址码AD(IR)
6. $CU = OP(IR)$，IR将分析得出的操作码送往CU，让CU分析对应的操作
7. $MAR = AD(IR)$，IR将分析得出的地址码送往MAR，找到需要执行的内存单元
8. 进行对应操作，重复2~8流程，直至程序结束

##### 指令执行过程

1. 取指令
	1. PC -> MAR -> M -> MDR -> IR
	2. 将PC取指令到IR，将PC中的内容送往MAR，MAR中的内容送往存储体中索取对应数据，主存通过地址线上的之地和读信号，从指定存储单元读出指令送到数据线上，MDR从数据线上接受指令信息，传送到IR中
2. 分析指令
	1. OP(IR) -> CU
	2. 指令译码并送出控制信号，控制器CU根据IR中指令的操作码，生成相应的控制信号，送到不同的执行部件
3. 执行指令
	1. AD(IR) -> MAR -> M -> MDR -> ACC
	2. 取数操作。将IR中指令的地址码送给MAR，MAR中的内容送入地址线，同时控制器将读信号送读/写信号线，从主存中取出操作数，并通过数据线送至MDR，再传送至ACC中
4. **每次读完指令，PC就会立即指向下一条指令的地址，$(PC) = (PC) + 1$

##### 代码的简单执行逻辑

1. $(PC) = 0x0$，PC寄存器指向第一条指令的存储地址
2. $MAR = (PC)$，使得$(MAR) = 0$，找到了主存地址为0的位置
3. $(PC) = (PC) + 1$，执行完后，PC指向下一条指令
4. $MDR = M(MAR)$，使得$(MDR) = 000001 0000000101$
5. $IR = (MDR)$，IR寄存器得到指令，开始分析，$OP(IR) = 0000001$，$AD(IR) = 0000000101$
6. $CU = OP(IR)$，将操作码送往CU，CU分析指令，得出是“取数”指令
7. $MAR = AD(IR)$，将地址码送往MAR，使得$(MAR) = 0x5$
8. $MDR = M(MAR)$，将对应地址码中的数据取出，存放在MDR中，使得$(MDR) = 0x2$
9. $ACC = (MDR)$，将MDR的数据送往ACC累加寄存器中，$(ACC) = 0x2$

- 上述步骤其实就是代码中的$int \ a = 2$语句，但是因为$y = a*b + c$的缘故，CPU决定将其送往ACC中，与后续的$b$做乘法后和$c$进行相加操作，因此才会存放在ACC中。

### 计算机系统的多级层次结构

> 计算机是一个软硬件组合的综合体。由于面对应用范围越来越广，必须有复杂的系统软件和硬件的支持。
> 计算机系统的多级层次结构的作用，**就是根据从各种角度所看到的机器之间的有机联系，来分清彼此之间的界面，明确各自的功能，以便构成合理、高效的计算机系统**

> [!warning] 计算机系统层次结构的分层方式，没有统一的标准

- 层次表

| 层次结构 | 用法 | 示例 |
| :---: | :---: | :---: | 
| 虚拟机器 $M4$(高级语言机器) | 用**编译程序翻译**成**汇编语言程序** | $y = a * b + c$ |
| 虚拟机器 $M3$(汇编语言机器) | 用**汇编程序翻译**成**机器语言程序** | LOAD $5$ |
| 虚拟机器 $M2$(操作系统机器) | 向上提供“广义指令”(系统调用) |  |
| 传统机器$M1$(用机器语言的机器) | 用微程序解释机器指令，执行二进制机器指令 | $0000010000000101$ |
| 微程序机器$M0$(微指令系统) | 由硬件直接执行微指令 | PC、IR等 |

- 第一级是微程序机器层，这是一个实在的硬件层
- 第二级是传统机器语言层，也是一个实际的机器层
- 第三级是操作系统层，其由操作系统程序实现，而**操作系统程序是由机器指令和广义指令组成的**，这些广义指令是为了扩展机器功能而设置的，由操作系统定义和解释的软件指令，所以这一层也称为混合层
- 第四层是汇编语言层，其为用户提供一种符号化的语言
- 第五层是高级语言层，其是面向用户的，是为了方便用户编写应用程序而设置的。
- **没有配备软件的纯硬件系统被称为裸机**，**第三层~第五层称为虚拟机**，也就是软件实现的机器，虚拟机器只对该层的观察者存在。
- **层次之间的关系紧密，下层是上层的基础，上层是下层的扩展**

#### 编译

> 将高级语言写的源程序全部语句一次性全部翻译为机器语言程序 -> 一次编译，处处运行
> 代表语言类似：C/C++

- 类似于C/C++的编译，需要经过四个步骤
	- 预处理
	- 编译
	- 汇编
	- 链接

#### 解释

> 将源程序的一条语句翻译为对应机器语言的语句，并立即执行，直至将程序翻译执行完毕 -> 一次翻译，一次运行
> 代表语言类似：Python、JavaScript

- 类似于Python的解释，只需要经过两个步骤
	- 解释
	- 执行

### 计算机的性能指标

#### 存储器的性能指标

> 存储器的性能指标就是主存容量，通俗的讲就是内存大小。**主存容量是指主存储器所能存储信息的最大容量，通常用字节来衡量**

- 主存容量的大小与**MAR和MDR**有关

$$ 
\begin{aligned} 
   &Memory = MAR * MDR \\ 
   eg. MAR = 2^{32}, &\ \ \ MDR = 8bit \rightarrow Memory = 2^{32} * 8bit = 4GB
\end{aligned} 
$$

#### CPU的性能指标

> CPU的性能指标通常和CPU的时钟周期、主频等有关。

##### CPU时钟周期

> 通常为节拍脉冲或T周期，即主频的倒数，它是CPU中最小的时间单位，**执行指令的每个动作至少需要一个时钟周期**

$$ CPU时钟周期 = \frac{1}{CPU主频}Hz $$

##### CPU主频

> CPU主频也被叫做CPU时钟频率。机器内部主时钟的频率，**是衡量机器速度的重要参数**。**对于同一个型号的计算机，其主频越高，完成指令的一个执行步骤所用的时间越短，执行指令的速度越快**

$$ CPU主频 = \frac{1}{CPU时钟周期}Hz $$

##### CPI(Clock cycle Per Instruction)

> CPI，即执行一条指令所需的时钟周期数。不同指令的时钟周期数可能不同，甚至同指令完成的时钟周期数也不同，**因此，一般来说，CPI指该程序或该机器指令集中所有的指令执行所需的平均时钟周期数，此时CPI是一个平均值**

$$ per\_cmd\_cost = CPI \times CPU时钟周期 $$

- Eg：某CPU主频为1000Hz，某程序包括100条指令，平均来看指令的$CPI = 3$。该程序在该CPU上执行需要多久？

$$ 答：time = 100 * CPI * \frac{1}{1000} = 0.3s $$

##### CPU执行时间

> 指运行一个程序所花费的时间

$$ CPU\_cost\_time = \frac{CPU时钟周期数}{主频} = \frac{指令条数 \times CPI}{主频} $$
- 上述表明，CPU的性能(执行时间)取决于三个要素：主频、CPI和指令条数
- 其中，主频、CPI和指令条数是相互制约的，更改指令集可以减少程序所含的指令条数，但可能引起CPU结构的调整，从而增加时钟周期的宽度(降低主频)。

##### IPS

> IPS - Instruction Per Second，即每秒执行的指令数

$$ IPS = \frac{主频}{CPI} $$
- 其中，对于每秒执行的指令数，不止有IPS，还有KIPS、MIPS

##### FLOPS

> FLOPS - Floating-point Operations Per Second，每秒执行多少次浮点运算，还有KFLOPS、MFLOPS、GFLOPS、TFLOPS

- 注意：IPS和FLOPS一样，K、M、G、T为数量单位，而非计算机的二进制，而是十进制

#### 系统整体的性能指标

> 系统整体性能指标，通常使用带宽和字长等来表示的

##### 字长

> 字长是指计算机进行一次整数运算(即定点整数运算)所能处理的二进制数据的位数，通常与CPU的寄存器位数、加法器有关。**因此，字长一般等于内部寄存器的大小，字长越长，数据的比爱是范围越大**

- 字：用来表示被处理信息的单位，用来度量数据类型的宽度
- 字长：指CPU内部用于整数运算的数据通路的宽度，反应了计算机处理信息的能力
- 机器字长：也就是字长
- 指令字长：一个指令字中包含的二进制代码位数，取决于操作码的长度
- 存储字长：一个存储单元存储的二进制代码长度

##### 数据通路带宽

> 数据通路带宽是指**数据总线一个所能并行传送信息的位数**，而此处所说的带宽是指外部数据总线的宽度，和CPU内部的数据总线宽度(内部寄存器)可能不同
> **各个子系统通过数据总线连接形成的数据传送路径称为数据通路**

##### 吞吐量

> **指系统在单位时间内处理请求的数量。其取决于信息能多快地输入内存，CPU能多快地取指令，数据能多快地从内存中取出或存入，以及所得结果能多快地从内存中送给外部设备**。这些步骤中的每一步都关系到主存，因此，系统吞吐量主要取决于主存的存储周期

##### 响应时间

> 指从用户像计算机发送一个请求，到系统对该请求做出相应并获得所需要结果的等待时间。

- 通常包括CPU时间(运行一个程序所花费的时间)与等待时间(用于磁盘访问、存储器访问、I/O操作、操作系统开销等)

##### 基准程序

> 专门用来进行性能评价的一组程序，能够很好地反映机器在运行实际负载时的性能，可以通过在不同机器上运行相同的基准程序来比较在不同机器上的运行时间，从而评测其性能

- 对于不同的场合，应该选取不同的基准程序
- 基准程序的性能存在缺陷。