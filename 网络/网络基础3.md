

#### 硬件类型

> 指链路层网络类型，1为以太网

# 网络基础3

---

## 网络层

### IP协议

- IP
> 具有一种能力，将数据跨网络传送到对端主机的能力

- 主机
> 配有IP地址，但是不进行路由控制的设备

- 路由器
> 即配有IP地址，又能进行路由控制

- 节点
> 主机和路由器的统称

![[Pasted image 20220820202947.png]]

#### 4位版本

> 代表的是IP的协议，例如IPV4就是4

#### 8位协议

> 表示上层协议的类型

#### 8位服务类型(TOS)

- 3位优先权字段(已弃用)
- 4位TOS字段
- 1位保留字段(必须置为0)

> 4位TOS字段分别表示：
>> 最小延时，最大吞吐量，最高可靠行，最小成本
>> **这四者相互冲突，只能选择其一**
>> 对于ssh/telnet这样的应用，最小延时比较重要，FTP这样的，最大吞吐量比较重要

#### 16位总长度

> 为了解决IP报文和报文之间的分离

#### 8位生存时间(TTL)

> 一个报文能经过节点的最大次数，如果次数为0，则被丢弃

#### 3位标志

> 确定IP协议是否需要分片

- 第一位保留
- 第二位为1，标识禁止分片。**如果这时报文长度超过MTU，IP模块则会丢弃报文**
- 第三位标识“更多分片”。**如果设置为1，标识后续还有报文，如果为0，标识后续没有报文**

#### 16位标识

> 对每一个IP进行唯一性标识。**如果IP报文在数据链路层被分片了，那么每一片里面的这个标识都是相同的**

#### 13位片偏移

> 对分片后的每一片报文的偏移量进行记录。**实际偏移量是该值乘以8得到的。因此，除了最后一个报文之外，其他报文的长度必须是8的整数**


### 分片和组装

- **注意：IP报文的分片是不常规现象**

#### 分片

> 当IP数据报超过帧的MTU(最大传输单元)时，它将会被分片传输。**分片能发生在发送端或者中转路由器，且在传输过程中可能被多次分片。在最后的目标机器上这些分片才会被内核的的IP模块重新组装**。

- 注意：
	- Mac规定了MTU(IP的报头 + IP的数据)
	- 对于TCP和Mac来说，不关心IP是否分片
	- 当 IP 数据报被分片后，**只有第一个分片里有运输层协议首部，其余分片都不包含运输层协议的首部**，但是每个分片都具有IP首部，并且每一片都成为一个分组，在选择路由时每一组与其他分组相互独立。
	- IP的报文长度，**不由IP决定，由传输层MSS(最大传输段尺寸(MTU - 20 - 20))决定**


#### 组装

> 提取出每一个分片的报文，然后根据16位标识，聚合“所有”的分片报文

- 如何知道全部分片已经收到？

> 开头没有丢失，中间没有丢失，收到了结尾报文(3位标识的第三位是0)

## 网段划分

- IP地址分为两个部分，主机号和网络号
> 网络号：保证相互连接的两个网段 具有不同的标识
> 主机号：同一网段内，主机之间具有相同的网络号，但是必须有不同的主机号

### CIDR

> Classless interdomain Routing

- 引入一个额外的子网掩码来区分网络号和主机号
- 子网掩码也是一个32位的正整数，通常用一串"0"来结尾
- 将IP地址和子网掩码进行"按位与"操作，得到的就是网络号
- 网络号和主机号的划分与IP地址是A、B类等无关

## 特殊IP

> 将IP全部设置为0，成为网络号。代表这个局域网
> 将IP全部设置为1，成为广播地址。用于给同一个链路中相互链接的所有主机发送数据包
> 127.\*的IP地址用于本机环回(loop back)测试，通常是127.0.0.1

## 私有IP和公网IP

- 私有IP
	- 10.\*前8位都是网络号，共16777216个地址
	- 172.16.到172.31.前12位时网络号，共1048576个地址
	- 192.168.\*前16位是网络号，共65536个地址
	- 包含在这个返回中的，全是私有IP，其余的全部都是公网IP

## 数据链路层

> 用于两个设备(同一种数据链路节点)之间的数据传递

### 以太网

> 以太网不是一种具体的网络，而是一种技术标准；既包含了数据链路层的内容，也包含了一些物理层的内容。

### 以太网帧格式

![[Pasted image 20220823124634.png]]

![[Pasted image 20220823124734.png]]

#### 源地址和目的地址

> 指网卡的硬件地址(即MAC地址)，长度是48位，**是在网卡出厂时固化的**

#### 帧协议类型

> 有三种值，IP(0800)，ARP(0806)，RARP(8035)

#### CRC校验码

> 是数据通信领域中最常用的一种查错校验码，其特征是信息字段和校验字段的长度可以任意选定。 
> 循环冗余检查（CRC）是一种数据传输检错功能，对数据进行多项式计算，并将得到的结果附在帧的后面，接收设备也执行类似的算法，以保证数据传输的正确性和完整性。

### MAC地址

- MAC地址用来识别数据链路层中项链的节点
- 长度为48位及6个字节，一般用16进制数字加上冒号的形式来标识
- 在网卡出厂的时候就确定了，不能修改，MAC地址通常是唯一的(虚拟机中的MAC地址不是真实的MAC地址，可能会冲突；也有网卡支持用户配置MAC地址)

#### 对比IP和MAC

- IP地址描述的时**路途总体的起点和终点**
- MAC地址描述的时**路途上的每一个区间的起点和终点**

### MTU

> MTU相当于对包裹尺寸大小的限制，这个限制是不同数据链路层对应的物理层从而产生的限制

- 以太网帧中的数据长度规定最小46字节，最大1500字节，ARP数据包的长度不够46字节，因此要补填充位PAD
- 最大值1500称为以太网的最大传输单元(MTU)，不同网络类型有不同的MTU
- 如果数据包的长度大于拨号链路的MTU，则需要分片

#### MTU和IP

> 由于数据链路层MTU的限制，对于较大的IP数据包需要进行分片

- 将较大的IP包分成多个小包，并打上标识
- 每个小包的IP协议头的16位标识都是相同的
- 每个小包的IP协议头的3位标志中，第二位为0，表示允许分片，第三位表示结束标记
- 到达对端时再将这些小包按顺序重组，拼装到一起返回给传输层
- **一旦这些小包中任意一个小包丢失，接收端的重组就会失败，但是IP层不会负责重新传输数据**

#### MTU和TCP

> TCP的一个数据报不能无限大.受限制于MTU。TCP的单个数据报的最大消息长度，称为MSS
> TCP在建立连接的过程中，双方会进行MSS协商
> **最理想的情况下，MSS的值正好是在IP不会被分片处理的最大长度**
> MSS的值就在TCP首部报文中的40字节变长选项中(kind = 2)

### ARP协议

> 报文到达目的网络后，只知道目标主机的IP地址，需要通过IP地址获取MAC地址，叫做ARP协议

![[Pasted image 20220823160116.png]]

#### 源MAC地址和目的MAC地址

> 在以太网首部和ARP请求中各出现一次，**对于链路层是以太网的情况是多余的，但是如果是其他类型的网络则是可能必要的**

#### 协议类型

> 指要转换的地址类型，0x0800为IP地址

#### 硬件地址长度

> 对于以太网地址为6字节

#### 协议地址长度

> 对于IP地址为4字节

#### op字段

> op字段为1表示ARP请求，op字段为2表示ARP应答

#### 处理流程

1. 发起方构建ARP请求，以广播的方式发送给每一台主机
2. 每台主机都能识别且接受，根据MAC，帧类型(0806)，交付给每个主机的ARP层
3. 其他不相关主机，立马根据目的IP，在自己的ARP协议内部**丢弃掉该ARP请求，只有目标主机会接受且处理**
4. 目标主机构建好ARP应答(将ARP协议内部的发送端地址填充)，以一对一的方式将数据返回给源主机
5. 根据op判定是ARP请求还是应答，如果是应答，提取出ARP应答中的发送端MAC地址和发送端IP地址

- 注意：
	- 当收到ARP协议的时候，第一时间查看的是op。**因为任何一台主机都有可能发起ARP，或者接受ARP**

### RARP协议

> 逆地址解析协议，将MAC地址转化为IP地址

## DNS

> 一整套从域名映射到IP的系统

- 底层协议使用的是UDP，浏览器一般第一件事(不考虑缓存)就是域名解析

