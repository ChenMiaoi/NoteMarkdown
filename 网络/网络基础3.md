# 网络基础3

---

## 网络层

### IP协议

- IP
> 具有一种能力，将数据跨网络传送到对端主机的能力

- 主机
> 配有IP地址，但是不进行路由控制的设备

- 路由器
> 即配有IP地址，又能进行路由控制

- 节点
> 主机和路由器的统称

![[Pasted image 20220820202947.png]]

#### 4位版本

> 代表的是IP的协议，例如IPV4就是4

#### 8位协议

> 表示上层协议的类型

#### 8位服务类型(TOS)

- 3位优先权字段(已弃用)
- 4位TOS字段
- 1位保留字段(必须置为0)

> 4位TOS字段分别表示：
>> 最小延时，最大吞吐量，最高可靠行，最小成本
>> **这四者相互冲突，只能选择其一**
>> 对于ssh/telnet这样的应用，最小延时比较重要，FTP这样的，最大吞吐量比较重要

#### 16位总长度

> 为了解决IP报文和报文之间的分离

#### 8位生存时间(TTL)

> 一个报文能经过节点的最大次数，如果次数为0，则被丢弃

#### 3位标志

> 确定IP协议是否需要分片

- 第一位保留
- 第二位为1，标识禁止分片。**如果这时报文长度超过MTU，IP模块则会丢弃报文**
- 第三位标识“更多分片”。**如果设置为1，标识后续还有报文，如果为0，标识后续没有报文**

#### 16位标识

> 对每一个IP进行唯一性标识。**如果IP报文在数据链路层被分片了，那么每一片里面的这个标识都是相同的**

#### 13位片偏移

> 对分片后的每一片报文的偏移量进行记录。**实际偏移量是该值乘以8得到的。因此，除了最后一个报文之外，其他报文的长度必须是8的整数**


### 分片和组装

- **注意：IP报文的分片是不常规现象**

#### 分片

> 当IP数据报超过帧的MTU(最大传输单元)时，它将会被分片传输。**分片能发生在发送端或者中转路由器，且在传输过程中可能被多次分片。在最后的目标机器上这些分片才会被内核的的IP模块重新组装**。

- 注意：
	- Mac规定了MTU(IP的报头 + IP的数据)
	- 对于TCP和Mac来说，不关心IP是否分片
	- 当 IP 数据报被分片后，**只有第一个分片里有运输层协议首部，其余分片都不包含运输层协议的首部**，但是每个分片都具有IP首部，并且每一片都成为一个分组，在选择路由时每一组与其他分组相互独立。
	- IP的报文长度，**不由IP决定，由传输层MSS(最大传输段尺寸(MTU - 20 - 20))决定**


#### 组装

> 提取出每一个分片的报文，然后根据16位标识，聚合“所有”的分片报文

- 如何知道全部分片已经收到？

> 开头没有丢失，中间没有丢失，收到了结尾报文(3位标识的第三位是0)

## 网段划分

- IP地址分为两个部分，主机号和网络号
> 网络号：保证相互连接的两个网段 具有不同的标识
> 主机号：同一网段内，主机之间具有相同的网络号，但是必须有不同的主机号

### CIDR

> Classless interdomain Routing

- 引入一个额外的子网掩码来区分网络号和主机号
- 子网掩码也是一个32位的正整数，通常用一串"0"来结尾
- 将IP地址和子网掩码进行"按位与"操作，得到的就是网络号
- 网络号和主机号的划分与IP地址是A、B类等无关

